<!DOCTYPE html>
<html>
<header>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            background: black;
            color: white;
        }

        #video-track {
            display: none;
        }

        #video {
            margin: auto auto;
            height: calc(100vh - 100px);
        }

        .video-container {
            position: relative; /* Key: Establishes a positioning context for children */
            width: 100%; /* Or a specific width */
            height: auto; /* Or a specific height to define the container's bounds */
        }

        .video-container video {
            display: block;
        }

        .subtitle-overlay {
            position: absolute; /* Key: Position relative to the parent container */
            bottom: 0; /* Aligns the div to the bottom edge of the container */
            left: 0;
            right: 0;
            /*background-color: rgba(0, 0, 0, 0.7); /* Optional: semi-transparent background */
            color: white;
            text-shadow: 2px 2px #000000;
            padding: 10px;
            text-align: center;
            /* Ensure it is above the video controls if needed, though usually fine */
            z-index: 10;
        }
    </style>
</header>
<body>
    <div class="container-fluid">
        <div class="row mb-1">
            <div class="col-auto">
                <label class="form-label mt-2">Video:</label>
            </div>
            <div class="col-auto">
                <select id="videoList" class="form-select"></select>
            </div>
            <div class="col-auto audio-selection">
                <label class="form-label mt-2">Audio:</label>
            </div>
            <div class="col-auto audio-selection">
                <select id="tracks" class="form-select"></select>
            </div>
            <div class="col-auto legend-selection">
                <label class="form-label mt-2">Legenda:</label>
            </div>
            <div class="col-auto legend-selection">
                <select id="legends" class="form-select"></select>
            </div>
        </div>
        <div class="row mb-1">
            <div class="col">
                <div class="video-container">
                    <video id="video" class="d-flex justify-content-center"></video>
                    <div id="subtitles" class="subtitle-overlay fw-medium fs-3"></div>
                </div>
                <audio id="video-track" controls></audio>
            </div>
        </div>
        <div class="row pt-1 pb-1 sticky-bottom" id="play-bar">
            <div class="col-auto">
                <button id="next" class="btn btn-primary disabled">
                    <i class="fa-solid fa-angle-left"></i>
                </button>
            </div>
            <div class="col-auto">
                <button id="play-pause" class="btn btn-primary">
                    <i id="play" class="fa-solid fa-play"></i>
                    <i id="pause" class="fa-solid fa-pause"></i>
                </button>
            </div>
            <div class="col pt-2">
                <input id="video-timer" type="range" class="form-range" min="0" max="0">
            </div>
            <div class="col-auto pt-2">
                <span class="text-white"><span id="video-played-time">00:00</span>/<span id="video-duration">00:00</span></span>
            </div>
            <div class="col-auto">
                <button id="toggle-screen" class="btn btn-primary">
                    <i id="full-screen" class="fa-solid fa-expand"></i>
                    <i id="exit-full-screen" class="fa-solid fa-compress"></i>
                </button>
            </div>
            <div class="col-auto">
                <button id="next" class="btn btn-primary disabled" disabled="disabled">
                    <i class="fa-solid fa-angle-right"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/js/all.min.js" integrity="sha512-6BTOlkauINO65nLhXhthZMtepgJSghyimIalb+crKRPhvhmsCdnIuGcVbR5/aQY2A+260iC1OPy1oCdB6pSSwQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="./scripts/jquery.srt.js"></script>
    <script>
        var videoLoaded = false;
        var hasPlayedOnce = false;
        var videoPlaying = false;
        var videoFullscreen = false;
        var videoList = [];
        var videoSelected = undefined;

        $(document).ready(function () {
            //#region Init

            $("#play-pause #pause").hide();
            $("#toggle-screen #exit-full-screen").hide();
            loadVideos();

            //#endregion

            //#region Events Handers

            $("#videoList").change(function () {
                if (videoPlaying) {
                    $("#play-pause").trigger("click");
                }

                var src = videoList.find(x => x.playlist == $(this).val());
                if (src) {
                    play(src);
                }
            });

            $("#tracks").change(function () {
                let wasPlaying = videoPlaying;
                if (wasPlaying) {
                    $("#play-pause").trigger("click");
                }

                var hlsAudio = new Hls({
                    xhrSetup: function (xhr) { },
                });

                hlsAudio.loadSource($(this).val());
                hlsAudio.attachMedia($("#video-track")[0]);
                syncAudioToVideo();

                if (wasPlaying) {
                    $("#play-pause").trigger("click");
                }
            });

            $("#legends").change(function () {
                if ($(this).val() != '') {
                    $("#video").srt({
                        srt_track: $(this).val(),
                        default_url: `${window.location.protocol}//${window.location.hostname}${(window.location.port.length > 0 ? `:${window.location.port}` : '')}`
                    });
                } else {
                    $("#video").srt({});
                }
            });

            $("#play-pause").click(function() {
                if (videoPlaying) {
                    videoPlaying = false;
                    $("#play-pause #play").show();
                    $("#play-pause #pause").hide();
                    $("#video")[0].pause();
                    $("#video-track")[0].pause();
                } else {
                    videoPlaying = true;
                    $("#play-pause #play").hide();
                    $("#play-pause #pause").show();
                    syncAudioToVideo();
                    $("#video")[0].play();
                    $("#video-track")[0].play();
                }
            });

            $("#video-timer").change(function() {
                $("#video-track")[0].currentTime = $(this).val();
                $("#video")[0].currentTime = $(this).val();
            });

            $("#toggle-screen").click(function() {
                let videoElement = $("#video")[0];
                if (!videoFullscreen) {
                    videoFullscreen = true;
                    $("#toggle-screen #exit-full-screen").show();
                    $("#toggle-screen #full-screen").hide();
                    if (videoElement.requestFullscreen) {
                        videoElement.requestFullscreen();
                    } else if (videoElement.mozRequestFullScreen) { /* Firefox */
                        videoElement.mozRequestFullScreen();
                    } else if (videoElement.webkitRequestFullscreen) { /* Chrome, Safari & Opera */
                        videoElement.webkitRequestFullscreen();
                    } else if (videoElement.msRequestFullscreen) { /* IE/Edge */
                        videoElement.msRequestFullscreen();
                    }
                } else {
                    videoFullscreen = false;
                    $("#toggle-screen #exit-full-screen").hide();
                    $("#toggle-screen #full-screen").show();
                    if (videoElement.exitFullscreen) {
                        videoElement.exitFullscreen();
                    } else if (videoElement.mozCancelFullScreen) { // Firefox
                        videoElement.mozCancelFullScreen();
                    } else if (videoElement.webkitExitFullscreen) { // Chrome, Safari & Opera
                        videoElement.webkitExitFullscreen();
                    } else if (videoElement.msExitFullscreen) { // IE/Edge
                        videoElement.msExitFullscreen();
                    }
                }
            });

            //#endregion

            //#region Functions

            function getVideos(callback) {
                $.ajax({
                    url: "Streaming/Videos",
                    method: "GET",
                    dataType: "json",
                    async: true,
                    success: function (response) {
                        callback(response);
                    }
                });
            }

            function loadVideos() {
                getVideos(function (videos) {
                    videoList = videos;
                    $("#videoList").empty();

                    videos.forEach((video) => {
                        let opt = $(`<option value="${video.playlist}">${video.name}</option>`);
                        $("#videoList").append(opt);
                    });

                    if (videos.length > 0) play(videos[0]);
                });
            }

            function play(src) {
                videoSelected = src;
                $("#tracks").empty();
                $("#legends").empty();

                if (src.tracks.length > 0) {
                    $(".audio-selection").show();
                    for (var i = 0; i < src.tracks.length; i++) {
                        let trackName = src.tracks[i].replace(`/${src.tracks[i].split('/').pop()}`, '').split('/').pop();
                        let opt = $(`<option value="${src.tracks[i]}">${trackName}</option>`);
                        $("#tracks").append(opt);
                    }
                } else {
                    $(".audio-selection").hide();
                }

                if (src.legends.length > 0) {
                    $(".legend-selection").show();
                    $("#legends").append($(`<option value="">Sem Legenda</option>`));
                    for (var i = 0; i < src.legends.length; i++) {
                        let legendName = src.legends[i].split('/').pop().split('.')[0];
                        let opt = $(`<option value="${src.legends[i]}">${legendName}</option>`);
                        $("#legends").append(opt);
                    }
                } else {
                    $(".legend-selection").hide();
                }

                if (videoLoaded) {
                    $($("#video")[0]).unbind("timeupdate");
                    $($("#video")[0]).unbind("loadedmetadata");
                    $($("#video")[0]).unbind("fullscreenchange");
                }

                if (Hls.isSupported()) {
                    var hlsVideo = new Hls({
                        xhrSetup: function (xhr) { },
                    });

                    hlsVideo.loadSource(src.playlist);
                    hlsVideo.attachMedia($("#video")[0]);

                    if (src.tracks.length > 0) {
                        var hlsAudio = new Hls({
                            xhrSetup: function (xhr) { },
                        });

                        hlsAudio.loadSource(src.tracks[0]);
                        hlsAudio.attachMedia($("#video-track")[0]);

                        $("#video").removeAttr('controls');
                        $("#play-bar").show();
                    } else {
                        $("#video").attr('controls', '');
                        $("#play-bar").hide();
                    }
                } else {
                    $("#video").src = src.playlist;
                    if (src.tracks.length > 0) {
                        $("#video-track").src = src.tracks[0];
                        $("#video").removeAttr('controls');
                        $("#play-bar").show();
                    } else {
                        $("#video").attr('controls', '');
                        $("#play-bar").hide();
                    }
                }

                videoLoaded = true;
                $($("#video")[0]).on('timeupdate', setVideoCurrentTime);
                $($("#video")[0]).on('loadedmetadata', setVideoDuration);
                $($("#video")[0]).on('fullscreenchange', fullscreenchangeHandler);
            }

            function setVideoCurrentTime() {
                syncAudioToVideo();
                let currentTime = $("#video")[0].currentTime;
                $("#video-played-time").text(`${formatTime(currentTime)}`);
                $("#video-timer").val(`${currentTime}`);
            };

            function setVideoDuration() {
                let duration = $("#video")[0].duration;
                $("#video-duration").text(formatTime(duration));
                $("#video-timer").attr("max", duration);
            }

            function fullscreenchangeHandler() {
                if (document.fullscreenElement) {
                    $("#video").removeAttr('controls');
                } else if (videoFullscreen) {
                    $("#toggle-screen").trigger("click");
                }
            }

            function formatTime(time) {
                var minutes = Math.floor(time / 60);
                var seconds = Math.floor(time % 60);
                // Add leading zeros if needed
                minutes = (minutes < 10) ? "0" + minutes : minutes;
                seconds = (seconds < 10) ? "0" + seconds : seconds;
                return minutes + ":" + seconds;
            }

            function syncAudioToVideo() {
                if (videoSelected.tracks.length > 0) {
                    let videoCt = $("#video")[0].currentTime;
                    let audioCt = $("#video-track")[0].currentTime;
                    let diff = videoCt - audioCt;
                    if (diff <= -0.7 || diff >= 0.7) {
                        //console.log(`Video ct: ${videoCt}`, `Audio ct: ${audioCt}`, `ct diff ${diff}`);
                        $("#video-track")[0].currentTime = $("#video")[0].currentTime;
                        //console.log(`Syncronized video and audio:`, `Video ct: ${$("#video")[0].currentTime}`, `Audio ct: ${$("#video")[0].currentTime}`);
                    }
                }
            }

            //#endregion
        });
    </script>
</body>
</html>
